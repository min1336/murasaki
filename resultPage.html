<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Result Page</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
    <style>
        /* 차트의 크기를 조정하는 CSS */
        #radarChart {
            width: 500px !important;
            height: 500px !important;
        }
        /* 스타일 정의 */
        .capture-area {
            width: 300px;
            height: 200px;
            background-color: #e0f7fa;
            text-align: center;
            padding: 20px;
            border: 2px solid #00838f;
        }

        .capture-button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 1em;
            background-color: #00796b;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .capture-button:hover {
            background-color: #004d40;
        }

        #qrcode {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Result Page</h1>
    <div id="result-display"></div>
    <div id="ranking-display"></div>
    <canvas id="radarChart" width="400" height="400"></canvas>

    <!-- 캡처할 영역 -->
    <div class="capture-area" id="captureArea">
        <h2>캡처할 영역</h2>
        <p>이 부분이 캡처되어 QR 코드로 변환됩니다.</p>
    </div>

    <!-- 캡처 버튼 -->
    <button class="capture-button" onclick="captureArea()">캡처하기</button>

    <!-- QR 코드 생성 영역 -->
    <h2>QR 코드</h2>
    <div id="qrcode"></div>

    <script>
        const scores = ['love', 'joy', 'peace', 'patience', 'kindness', 'goodness', 'faithfulness', 'gentleness', 'selfControl'];
        const resultDisplay = document.getElementById("result-display");

        let totalNextPageScore = 0;
        let totalThirdPageScore = 0;

        const totalScores = [];

        for (const score of scores) {
            const nextpageScoreValue = parseInt(sessionStorage.getItem(`nextpage_${score}Score`)) || 0;
            const thirdpageScoreValue = parseInt(sessionStorage.getItem(`thirdpage_${score}Score`)) || 0;
            const totalScore = nextpageScoreValue + thirdpageScoreValue;

            totalScores.push({ scoreType: score, totalScore });

            const scoreElement = document.createElement("p");
            scoreElement.textContent = `${score} 점수: ${nextpageScoreValue} (nextpage) + ${thirdpageScoreValue} (thirdpage) = ${totalScore}`;
            resultDisplay.appendChild(scoreElement);

            totalNextPageScore += nextpageScoreValue;
            totalThirdPageScore += thirdpageScoreValue;
        }

        // 점수 순위 매기기
        const sortedScores = totalScores.sort((a, b) => b.totalScore - a.totalScore);
        
        // 상위 순위 출력
        const rankingDisplay = document.getElementById("ranking-display");
        rankingDisplay.innerHTML = "<h2>순위</h2>";
        sortedScores.forEach((item, index) => {
            const rankElement = document.createElement("p");
            rankElement.textContent = `${index + 1}위: ${item.scoreType} - 총 점수 ${item.totalScore}`;
            rankingDisplay.appendChild(rankElement);
        });

        // 차트 데이터
        const chartLabels = scores;
        const chartData = totalScores.map(item => item.totalScore);

        // 9각형 그래프 생성
        const ctx = document.getElementById("radarChart").getContext("2d");
        new Chart(ctx, {
            type: "radar",
            data: {
                labels: chartLabels,
                datasets: [{
                    label: "Total Combined Scores",
                    data: chartData,
                    backgroundColor: "rgba(75, 192, 192, 0.2)",
                    borderColor: "rgba(75, 192, 192, 1)",
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 10
                    }
                }
            }
        });

        function captureArea() {
            // 캡처할 영역 요소 가져오기
            const captureElement = document.getElementById("captureArea");

            // html2canvas을 사용해 해당 요소 캡처
            html2canvas(captureElement).then(canvas => {
                // 캡처된 내용을 이미지 데이터로 변환
                const imageData = canvas.toDataURL("image/png");

                // QR 코드 생성
                generateQRCode(imageData);
            });
        }

        function generateQRCode(imageData) {
            $('#qrcode').empty(); // 기존 QR 코드 제거
            $('#qrcode').qrcode({
                text: imageData,
                width: 256, // 크기를 늘려 스캔을 쉽게 만듭니다.
                height: 256
            });
        }
    </script>
</body>
</html>
